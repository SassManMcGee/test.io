<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Touch Interaction Experiment</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    text-align: center;
    padding: 30px;
    overflow: hidden;
}

#trial-info { font-size: 18px; }
#condition-info { font-size: 14px; color: #555; margin-bottom: 20px; }

#button-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    max-width: 600px;
    margin: 60px auto;
}

.test-button {
    height: 80px;
    font-size: 18px;
    border: none;
    border-radius: 12px;
    color: white;
    touch-action: none;
}

.red { background:#dc3545; }
.blue { background:#007bff; }
.orange { background:#fd7e14; }
.purple { background:#6f42c1; }

.target { background:#28a745; }

#feedback { margin-top:20px; font-weight:bold; }

#results {
    margin-top:40px;
    max-width:800px;
    margin-left:auto;
    margin-right:auto;
    background:white;
    padding:15px;
    border-radius:8px;
    font-family:monospace;
    font-size:13px;
    white-space:pre;
}

/* Motion */
@keyframes shakeX {
    0%{transform:translateX(0)}
    25%{transform:translateX(-6px)}
    50%{transform:translateX(6px)}
    75%{transform:translateX(-6px)}
    100%{transform:translateX(0)}
}
@keyframes shakeY {
    0%{transform:translateY(0)}
    25%{transform:translateY(-6px)}
    50%{transform:translateY(6px)}
    75%{transform:translateY(-6px)}
    100%{transform:translateY(0)}
}
@keyframes shakeXY {
    0%{transform:translate(0,0)}
    25%{transform:translate(-6px,6px)}
    50%{transform:translate(6px,-6px)}
    75%{transform:translate(-6px,-6px)}
    100%{transform:translate(0,0)}
}
</style>
</head>

<body>

<h1>Touch Interaction Experiment</h1>
<div id="trial-info"></div>
<div id="condition-info"></div>
<div id="button-container"></div>
<div id="feedback"></div>
<div id="results"></div>

<script>
/* =============================
   Constants
============================= */

const EXPERIMENT_VERSION = "v3.0-2x7-target-distractor";
const participantID = crypto.randomUUID();

const activations = ["press","release"];
const motions = [
    "null","screen-x","button-x",
    "screen-y","button-y",
    "screen-xy","button-xy"
];

let trials = [];
activations.forEach(a => motions.forEach(m => trials.push({activation:a,motion:m})));
trials.sort(() => Math.random() - 0.5);

/* =============================
   State
============================= */

let currentTrial = 0;
let startTime = null;
let downTime = null;
let trialActive = true;

let firstDistractor = null;
let missCount = 0;

const results = [];

/* =============================
   DOM
============================= */

const trialInfo = document.getElementById("trial-info");
const conditionInfo = document.getElementById("condition-info");
const buttonContainer = document.getElementById("button-container");
const feedback = document.getElementById("feedback");
const resultsDiv = document.getElementById("results");

/* =============================
   Motion
============================= */

function applyMotion(el, cond) {
    el.style.animation = "";
    document.body.style.animation = "";

    if (cond === "null") return;

    const axis = cond.split("-")[1];
    const anim = axis === "x" ? "shakeX" :
                 axis === "y" ? "shakeY" : "shakeXY";

    if (cond.startsWith("screen")) {
        document.body.style.animation = `${anim} 0.4s infinite`;
    } else {
        el.style.animation = `${anim} 0.4s infinite`;
    }
}

function clearMotion() {
    document.body.style.animation = "";
}

/* =============================
   Trial Loader
============================= */

function loadTrial() {
    trialActive = true;
    buttonContainer.innerHTML = "";
    feedback.textContent = "";
    clearMotion();

    if (currentTrial >= trials.length) {
        endExperiment();
        return;
    }

    startTime = null;
    downTime = null;
    firstDistractor = null;
    missCount = 0;

    const trial = trials[currentTrial];
    trialInfo.textContent = `Trial ${currentTrial+1} / ${trials.length}`;
    conditionInfo.textContent = `${trial.activation.toUpperCase()} Ã— ${trial.motion.toUpperCase()}`;

    const colors = ["red","blue","orange","purple"];
    const targetIndex = Math.floor(Math.random()*8);

    let buttons = [];

    for (let i=0;i<8;i++) {
        const btn = document.createElement("button");
        btn.className = "test-button";
        btn.dataset.index = i;

        if (i === targetIndex) {
            btn.classList.add("target");
            btn.dataset.target = "true";
            btn.textContent = trial.activation === "press" ? "Press" : "Release";
        } else {
            const c = colors[Math.floor(Math.random()*colors.length)];
            btn.classList.add(c);
            btn.dataset.target = "false";
            btn.dataset.color = c;
        }

        buttonContainer.appendChild(btn);
        buttons.push(btn);
        applyMotion(btn, trial.motion);

        btn.addEventListener("pointerdown", e => {
            if (!trialActive) return;
            if (btn.dataset.target === "false" && !firstDistractor) {
                firstDistractor = {
                    index: i,
                    color: btn.dataset.color
                };
            }
        });
    }

    const targetButton = buttons[targetIndex];

    if (trial.activation === "press") {

        targetButton.addEventListener("pointerdown", e => {
            e.preventDefault();
            if (!trialActive) return;
            downTime = performance.now();
            startTime = downTime;
            registerResponse("pointerdown", targetIndex);
        });

    } else {

        document.addEventListener("pointerdown", globalDown);
        document.addEventListener("pointerup", globalUp);

        function globalDown() {
            if (!trialActive) return;
            downTime = performance.now();
            startTime = downTime;
        }

        function globalUp(e) {
            if (!trialActive) return;

            if (e.target === targetButton) {
                registerResponse("pointerup", targetIndex);
            } else {
                missCount++;
            }

            document.removeEventListener("pointerdown", globalDown);
            document.removeEventListener("pointerup", globalUp);
        }
    }
}

/* =============================
   Register Response
============================= */

function registerResponse(eventType, targetIndex) {
    if (!trialActive) return;
    trialActive = false;

    const now = performance.now();
    const rt = now - startTime;
    const hold = downTime ? now - downTime : "NA";

    results.push({
        participantID,
        version: EXPERIMENT_VERSION,
        trial: currentTrial+1,
        activation: trials[currentTrial].activation,
        motion: trials[currentTrial].motion,
        targetIndex,
        targetRow: Math.floor(targetIndex/2),
        targetCol: targetIndex % 2,
        eventType,
        reactionTime: rt.toFixed(2),
        holdDuration: hold !== "NA" ? hold.toFixed(2) : "NA",
        firstDistractorIndex: firstDistractor ? firstDistractor.index : "NA",
        firstDistractorColor: firstDistractor ? firstDistractor.color : "NA",
        misses: missCount
    });

    feedback.textContent = "Trial Complete";
    clearMotion();
    currentTrial++;

    setTimeout(loadTrial,700);
}

/* =============================
   End
============================= */

function endExperiment() {
    trialInfo.textContent = "Experiment Complete";
    conditionInfo.textContent = "";
    buttonContainer.innerHTML = "";

    let csv = "participant,version,trial,activation,motion,targetIndex,targetRow,targetCol,event,rt_ms,hold_ms,firstDistractorIndex,firstDistractorColor,misses\n";
    results.forEach(r => {
        csv += `${r.participantID},${r.version},${r.trial},${r.activation},${r.motion},${r.targetIndex},${r.targetRow},${r.targetCol},${r.eventType},${r.reactionTime},${r.holdDuration},${r.firstDistractorIndex},${r.firstDistractorColor},${r.misses}\n`;
    });

    resultsDiv.textContent = csv;
}

/* =============================
   Start
============================= */

loadTrial();
</script>

</body>
</html>
